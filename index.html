<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Lab Booking System – Firebase Version</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body { font-family: Arial,sans-serif; background:#f4f6f8; margin:0; padding:20px; }
h1 { text-align:center; }
.section { max-width:1100px; margin:20px auto; background:#fff; padding:15px; border-radius:6px; box-shadow:0 2px 6px rgba(0,0,0,0.1); }
.calendars { display:grid; grid-template-columns:1fr 1fr; gap:30px; }
.calendar { background:white; border-radius:6px; padding:10px; box-shadow:0 2px 6px rgba(0,0,0,0.1); }
.month-bar { text-align:center; font-weight:bold; margin-bottom:5px; }
.arrow { cursor:pointer; padding:0 10px; user-select:none; }
.days { display:grid; grid-template-columns:repeat(7,1fr); gap:4px; font-size:12px; }
.day-header { text-align:center; font-weight:bold; }
.day { height:70px; border:1px solid #ccc; position:relative; cursor:pointer; }
.day.today { border:3px solid #000; }
.date-number { position:absolute; bottom:2px; left:2px; font-size:11px; z-index:1; }
.booking { font-size:11px; color:white; padding:2px 4px; border-radius:3px; margin-top:2px; cursor:pointer; display:block; }
.overlay { position:fixed; inset:0; background:rgba(0,0,0,0.4); display:none; z-index:999; }
.popup { position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:white; padding:15px; width:350px; z-index:1000; box-shadow:0 4px 10px rgba(0,0,0,0.3); display:none; }
.error { color:#c0392b; font-size:12px; margin-top:6px; }
button, input, select { cursor:pointer; margin-top:5px; }
input, select, button { width:100%; box-sizing:border-box; }

/* ===== USER LIST INLINE ===== */
.user-item { display:flex; justify-content:space-between; align-items:center; margin-top:4px; }
.user-item button { width:auto; margin-left:10px; padding:2px 6px; font-size:11px; }

/* ===== RESPONSIVE STYLES ===== */
@media (max-width: 768px) {
  .calendars { grid-template-columns: 1fr; }
}
@media (max-width: 480px) {
  .day { height:50px; font-size:10px; }
  .day-header { font-size:10px; }
  .booking { font-size:9px; padding:1px 3px; }
  .popup { width:90%; }
}
</style>
</head>
<body>

<h1>Lab Booking System – Firebase Version</h1>

<div class="section">
  <h2>Users</h2>
  <input id="newUser" placeholder="User name">
  <button id="addUserBtn">Add</button>
  <div id="userList"></div>
</div>

<div class="calendars">
  <div class="calendar">
    <div class="month-bar">
      <span class="arrow" id="prev0">←</span>
      <span id="month0"></span>
      <span class="arrow" id="next0">→</span>
    </div>
    <h3 id="computer0" class="editable"></h3>
    <div class="days" id="days0"></div>
  </div>
  <div class="calendar">
    <div class="month-bar">
      <span class="arrow" id="prev1">←</span>
      <span id="month1"></span>
      <span class="arrow" id="next1">→</span>
    </div>
    <h3 id="computer1" class="editable"></h3>
    <div class="days" id="days1"></div>
  </div>
</div>

<div class="overlay" id="overlay"></div>
<div class="popup" id="popup">
  <h3 id="popupTitle"></h3>
  <label>User:
    <select id="userSelect"></select>
  </label>
  <label><input type="radio" name="type" value="day" checked> Whole day</label>
  <label><input type="radio" name="type" value="hours"> Time range</label>
  <label>From <input type="time" id="start" value="08:00"></label>
  <label>To <input type="time" id="end" value="18:00"></label>
  <div class="error" id="error"></div><br>
  <button id="saveBookingBtn">Save</button>
  <button id="deleteBookingBtn">Delete Booking</button>
  <button id="closePopupBtn">Cancel</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import { getFirestore, collection, doc, getDoc, setDoc, getDocs, addDoc, deleteDoc } 
  from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBEs0MJIB5uJZ_HF73jd3kjd3ltU0hrFVw",
  authDomain: "labbookingsystem2026.firebaseapp.com",
  projectId: "labbookingsystem2026",
  storageBucket: "labbookingsystem2026.firebasestorage.app",
  messagingSenderId: "76507123055",
  appId: "1:76507123055:web:5438a95b467b7b86262c9a",
  measurementId: "G-M5N2T033FS"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let localUsers = [];
let localBookings = [];
let computers = ["Computer 1","Computer 2"];
let month = [new Date().getMonth(), new Date().getMonth()];
let year = [new Date().getFullYear(), new Date().getFullYear()];
let selected = {};
const colors = ["#e74c3c","#3498db","#2ecc71","#f1c40f","#9b59b6"];

const newUserInput = document.getElementById("newUser");
const addUserBtn = document.getElementById("addUserBtn");
const userList = document.getElementById("userList");
const userSelect = document.getElementById("userSelect");
const overlay = document.getElementById("overlay");
const popup = document.getElementById("popup");
const popupTitle = document.getElementById("popupTitle");
const error = document.getElementById("error");
const startInput = document.getElementById("start");
const endInput = document.getElementById("end");
const saveBookingBtn = document.getElementById("saveBookingBtn");
const closePopupBtn = document.getElementById("closePopupBtn");
const deleteBookingBtn = document.getElementById("deleteBookingBtn");

// ===== FIRESTORE FUNCTIONS =====
async function loadComputers() {
  const docSnap = await getDoc(doc(db,"settings","computers"));
  if(docSnap.exists()){ computers = docSnap.data().names; }
  document.getElementById("computer0").textContent = computers[0];
  document.getElementById("computer1").textContent = computers[1];
}

async function saveComputers() { await setDoc(doc(db,"settings","computers"), { names: computers }); }

async function loadUsers() {
  const usersSnap = await getDocs(collection(db,"users"));
  localUsers = [];
  usersSnap.forEach(u=>localUsers.push({name:u.data().name, color:colors[localUsers.length%colors.length]}));
  renderUsers();
}

async function addUserToFirestore(name) { await addDoc(collection(db,"users"), { name }); await loadUsers(); }

async function loadBookings() {
  const bookingsSnap = await getDocs(collection(db,"bookings"));
  localBookings = [];
  bookingsSnap.forEach(b=>localBookings.push({...b.data(), id:b.id}));
  renderCalendar(0); renderCalendar(1);
}

async function addBookingToFirestore(b) { await addDoc(collection(db,"bookings"), b); await loadBookings(); }

// ===== RENDER FUNCTIONS =====
function isoDate(y,m,d){ return `${y}-${String(m+1).padStart(2,"0")}-${String(d).padStart(2,"0")}`; }

function renderUsers(){
  userList.innerHTML=""; userSelect.innerHTML="";
  localUsers.forEach(u=>{
    userSelect.innerHTML += `<option>${u.name}</option>`;
    const div = document.createElement("div"); div.className="user-item";
    div.innerHTML = `<span>${u.name}</span>`;
    const btn = document.createElement("button"); btn.textContent = "Remove";
    btn.onclick = async () => {
      if(!confirm(`Remove user "${u.name}" and all their bookings?`)) return;
      const usersSnap = await getDocs(collection(db,"users"));
      for(const docSnap of usersSnap.docs){ if(docSnap.data().name === u.name) await deleteDoc(docSnap.ref); }
      const bookingsSnap = await getDocs(collection(db,"bookings"));
      for(const docSnap of bookingsSnap.docs){ if(docSnap.data().user === u.name) await deleteDoc(docSnap.ref); }
      await loadUsers(); await loadBookings();
    };
    div.appendChild(btn); userList.appendChild(div);
  });
}

function renderCalendar(idx){
  const box = document.getElementById("days"+idx); box.innerHTML="";
  ["Mo","Tu","We","Th","Fr","Sa","Su"].forEach(d=>box.innerHTML+=`<div class="day-header">${d}</div>`);
  const first = new Date(year[idx],month[idx],1).getDay()||7;
  for(let i=1;i<first;i++) box.innerHTML+="<div></div>";
  const daysCount = new Date(year[idx],month[idx]+1,0).getDate();
  for(let d=1; d<=daysCount; d++){
    const date = isoDate(year[idx],month[idx],d);
    const cell = document.createElement("div"); cell.className="day";
    if(d===new Date().getDate() && month[idx]===new Date().getMonth() && year[idx]===new Date().getFullYear()) cell.classList.add("today");
    cell.innerHTML=`<div class="date-number">${d}</div>`;
    cell.onclick = ()=>{ selected={comp:idx,date}; popupTitle.textContent=`${computers[idx]} – ${date}`; overlay.style.display=popup.style.display="block"; error.textContent=""; };
    localBookings.filter(b=>b.date===date && b.computer===idx).forEach(b=>{
      const div = document.createElement("div"); div.className="booking"; div.style.background=b.color || colors[0];
      div.textContent = b.type==="day"?b.user:`${b.user} ${b.start}-${b.end}`; cell.appendChild(div);
    });
    box.appendChild(cell);
  }
  document.getElementById("month"+idx).textContent = new Date(year[idx],month[idx]).toLocaleString("default",{month:"long",year:"numeric"});
}

// ===== EVENTS =====
addUserBtn.onclick = async ()=>{ const name=newUserInput.value.trim(); if(!name||localUsers.find(u=>u.name===name)) return; await addUserToFirestore(name); newUserInput.value=""; };
document.getElementById("computer0").onclick = async ()=>{ const newName=prompt("Enter name for Computer 1", computers[0]); if(newName){ computers[0]=newName; await saveComputers(); renderCalendar(0); document.getElementById("computer0").textContent=newName; }};
document.getElementById("computer1").onclick = async ()=>{ const newName=prompt("Enter name for Computer 2", computers[1]); if(newName){ computers[1]=newName; await saveComputers(); renderCalendar(1); document.getElementById("computer1").textContent=newName; }};
closePopupBtn.onclick = ()=>{ overlay.style.display=popup.style.display="none"; error.textContent=""; };

saveBookingBtn.onclick = async ()=>{
  const user=userSelect.value; const type=document.querySelector("input[name=type]:checked").value; const start=startInput.value; const end=endInput.value;
  if(!user){ error.textContent="Select a user"; return; }
  if(type==="hours" && end<=start){ error.textContent="Invalid time range"; return; }
  const clash=localBookings.some(b=>b.date===selected.date && b.computer===selected.comp && (b.type==="day" || type==="day" || (start<b.end && end>b.start)));
  if(clash){ error.textContent="Time clash"; return; }
  const u=localUsers.find(x=>x.name===user); await addBookingToFirestore({user,color:u.color,type,start,end,date:selected.date,computer:selected.comp});
  overlay.style.display=popup.style.display="none";
};

deleteBookingBtn.onclick = async ()=>{
  const user=userSelect.value; if(!user){ error.textContent="Select a user"; return; }
  const bookingsSnap = await getDocs(collection(db,"bookings"));
  for(const b of bookingsSnap.docs){ const data=b.data(); if(data.date===selected.date && data.computer===selected.comp && data.user===user){ await deleteDoc(b.ref); break; } }
  await loadBookings();
  overlay.style.display=popup.style.display="none";
};

document.getElementById("prev0").onclick = ()=>{ month[0]--; if(month[0]<0){month[0]=11;year[0]--;} renderCalendar(0); };
document.getElementById("next0").onclick = ()=>{ month[0]++; if(month[0]>11){month[0]=0;year[0]++;} renderCalendar(0); };
document.getElementById("prev1").onclick = ()=>{ month[1]--; if(month[1]<0){month[1]=11;year[1]--;} renderCalendar(1); };
document.getElementById("next1").onclick = ()=>{ month[1]++; if(month[1]>11){month[1]=0;year[1]++;} renderCalendar(1); };

// ===== INITIAL LOAD =====
await loadComputers();
await loadUsers();
await loadBookings();

</script>
</body>
</html>
